# Flow Diagrams

**Document Version:** 1.0
**Date:** 2025-12-18
**Status:** Complete

This document contains all user flows, data flows, and sequence diagrams for Smart Composer.

---

## Table of Contents

1. [User Flows](#1-user-flows)
2. [Data Flows](#2-data-flows)
3. [Sequence Diagrams](#3-sequence-diagrams)
4. [State Machines](#4-state-machines)
5. [Error Flows](#5-error-flows)

---

## 1. User Flows

### 1.1 First-Time Setup Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    FIRST-TIME SETUP                              │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  Install Plugin from  │
                    │  Community Plugins    │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │    Enable Plugin      │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  Open Settings Tab    │
                    └───────────┬───────────┘
                                │
                                ▼
                ┌───────────────┴───────────────┐
                │                               │
                ▼                               ▼
    ┌─────────────────────┐         ┌─────────────────────┐
    │  Add API Provider   │         │  Use Claude Code    │
    │  (OpenAI, etc.)     │         │  (No API needed)    │
    └──────────┬──────────┘         └──────────┬──────────┘
               │                               │
               ▼                               ▼
    ┌─────────────────────┐         ┌─────────────────────┐
    │  Enter API Key      │         │  Install Claude CLI │
    └──────────┬──────────┘         │  Run: claude login  │
               │                    └──────────┬──────────┘
               └───────────────┬───────────────┘
                               │
                               ▼
                    ┌───────────────────────┐
                    │   Select Chat Model   │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ (Optional) Configure  │
                    │ Embedding Model       │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Open Chat View      │
                    │   (Ribbon Icon)       │
                    └───────────┬───────────┘
                                │
                                ▼
                         [ READY TO USE ]
```

### 1.2 Basic Chat Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      BASIC CHAT FLOW                             │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   User Opens Chat     │
                    │   (Ribbon or Cmd)     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Type Message        │
                    │   in Input Box        │
                    └───────────┬───────────┘
                                │
                                ▼
                ┌───────────────┴───────────────┐
                │       Want Context?           │
                │                               │
        ┌───────┴───────┐               ┌───────┴───────┐
        │      YES      │               │      NO       │
        ▼               │               │               │
┌───────────────┐       │               │               │
│ Add @mention  │       │               │               │
│ or attach img │       │               │               │
└───────┬───────┘       │               │               │
        │               │               │               │
        └───────────────┼───────────────┘               │
                        │                               │
                        ▼                               │
            ┌───────────────────────┐                   │
            │   Press Enter or      │◄──────────────────┘
            │   Click Send          │
            └───────────┬───────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │   Response Streams    │
            │   in Chat Window      │
            └───────────┬───────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │   Continue Chat or    │
            │   Start New Chat      │
            └───────────────────────┘
```

### 1.3 Vault Chat (RAG) Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    VAULT CHAT (RAG) FLOW                         │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   User Types Query    │
                    │   About Their Notes   │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Press Ctrl+Shift+   │
                    │   Enter (Vault Chat)  │
                    └───────────┬───────────┘
                                │
                                ▼
            ┌───────────────────────────────────────┐
            │              SYSTEM                   │
            ├───────────────────────────────────────┤
            │                                       │
            │   1. Check if index up-to-date        │
            │          │                            │
            │          ▼                            │
            │   2. Update modified files            │
            │      (show indexing progress)         │
            │          │                            │
            │          ▼                            │
            │   3. Embed user query                 │
            │          │                            │
            │          ▼                            │
            │   4. Similarity search                │
            │      (show "Querying..." status)      │
            │          │                            │
            │          ▼                            │
            │   5. Get top N results                │
            │          │                            │
            │          ▼                            │
            │   6. Build prompt with context        │
            │          │                            │
            │          ▼                            │
            │   7. Send to LLM                      │
            │                                       │
            └───────────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Display Response    │
                    │   with Citations      │
                    └───────────────────────┘
```

### 1.4 Apply Feature Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      APPLY FEATURE FLOW                          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   User Asks AI to     │
                    │   Modify a Note       │
                    │   e.g., "Rewrite the  │
                    │   introduction of X"  │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   AI Generates        │
                    │   <smtcmp_block>      │
                    │   with Changes        │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   User Clicks         │
                    │   "Apply" Button      │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Apply View Opens    │
                    │   Shows Diff          │
                    └───────────┬───────────┘
                                │
                                ▼
                ┌───────────────┴───────────────┐
                │                               │
                ▼                               ▼
    ┌─────────────────────┐         ┌─────────────────────┐
    │   Accept Block      │         │   Reject Block      │
    │   (Green Check)     │         │   (Red X)           │
    └──────────┬──────────┘         └──────────┬──────────┘
               │                               │
               ▼                               │
    ┌─────────────────────┐                    │
    │   Change Applied    │                    │
    │   to File           │                    │
    └──────────┬──────────┘                    │
               │                               │
               └───────────────┬───────────────┘
                               │
                               ▼
                    ┌───────────────────────┐
                    │   Continue or Close   │
                    │   Apply View          │
                    └───────────────────────┘
```

### 1.5 Template Usage Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     TEMPLATE USAGE FLOW                          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   In Chat Input,      │
                    │   Type "/" Character  │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Autocomplete Menu   │
                    │   Shows Templates     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Type Template Name  │
                    │   or Arrow Keys       │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Press Enter or      │
                    │   Click Template      │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Template Content    │
                    │   Inserted in Input   │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Modify if Needed    │
                    │   Then Send Message   │
                    └───────────────────────┘
```

### 1.6 MCP Tool Usage Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     MCP TOOL USAGE FLOW                          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   User Sends Message  │
                    │   That Needs Tool     │
                    │   e.g., "Check the    │
                    │   weather in NYC"     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   LLM Returns         │
                    │   tool_call Response  │
                    └───────────┬───────────┘
                                │
                                ▼
                ┌───────────────┴───────────────┐
                │    Tool Auto-Execute?         │
                │                               │
        ┌───────┴───────┐               ┌───────┴───────┐
        │      YES      │               │      NO       │
        │  (configured) │               │ (default)     │
        ▼               │               ▼               │
┌───────────────┐       │       ┌───────────────┐       │
│ Execute Tool  │       │       │ Show Tool     │       │
│ Automatically │       │       │ Request Badge │       │
└───────┬───────┘       │       └───────┬───────┘       │
        │               │               │               │
        │               │               ▼               │
        │               │       ┌───────────────┐       │
        │               │       │ User Clicks   │       │
        │               │       │ "Allow" or    │       │
        │               │       │ "Deny"        │       │
        │               │       └───────┬───────┘       │
        │               │               │               │
        └───────────────┴───────────────┘               │
                        │                               │
                        ▼                               │
            ┌───────────────────────┐                   │
            │   Execute MCP Tool    │                   │
            │   (Show Running...)   │                   │
            └───────────┬───────────┘                   │
                        │                               │
                        ▼                               │
            ┌───────────────────────┐                   │
            │   Show Tool Result    │                   │
            └───────────┬───────────┘                   │
                        │                               │
                        ▼                               │
            ┌───────────────────────┐                   │
            │   LLM Continues       │◄──────────────────┘
            │   With Result         │   (if denied, abort)
            └───────────────────────┘
```

---

## 2. Data Flows

### 2.1 Chat Message Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   CHAT MESSAGE DATA FLOW                         │
└─────────────────────────────────────────────────────────────────┘

USER INPUT                          PROCESSING                    OUTPUT
───────────                         ──────────                    ──────

┌─────────────┐                                           ┌─────────────┐
│ Text Input  │──┐                                        │  Streamed   │
└─────────────┘  │                                        │  Response   │
                 │                                        └─────────────┘
┌─────────────┐  │    ┌─────────────┐    ┌─────────────┐        ▲
│ @Mentions   │──┼───►│   Resolve   │───►│   Build     │        │
└─────────────┘  │    │  Mentions   │    │   Prompt    │        │
                 │    └─────────────┘    └──────┬──────┘        │
┌─────────────┐  │           │                  │               │
│ Images      │──┤           ▼                  │               │
└─────────────┘  │    ┌─────────────┐           │               │
                 │    │ File Content│           │               │
┌─────────────┐  │    │ Image Data  │           │               │
│ URLs        │──┘    └─────────────┘           │               │
└─────────────┘                                 │               │
                                                ▼               │
                            ┌─────────────────────────────┐     │
                            │        LLM REQUEST          │     │
                            ├─────────────────────────────┤     │
                            │ {                           │     │
                            │   model: "...",             │     │
                            │   messages: [               │     │
                            │     { role: "system", ...}, │     │
                            │     { role: "user", ...},   │     │
                            │     ...                     │     │
                            │   ],                        │     │
                            │   stream: true              │     │
                            │ }                           │     │
                            └─────────────┬───────────────┘     │
                                          │                     │
                                          ▼                     │
                            ┌─────────────────────────────┐     │
                            │       LLM PROVIDER          │     │
                            │  (OpenAI, Anthropic, etc.)  │     │
                            └─────────────┬───────────────┘     │
                                          │                     │
                                          ▼                     │
                            ┌─────────────────────────────┐     │
                            │    STREAMING RESPONSE       │─────┘
                            │  { delta: { content: "..."}}│
                            └─────────────────────────────┘
```

### 2.2 RAG Indexing Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   RAG INDEXING DATA FLOW                         │
└─────────────────────────────────────────────────────────────────┘

VAULT FILES                         PROCESSING                   DATABASE
───────────                         ──────────                   ────────

┌─────────────┐
│ note1.md    │
│ note2.md    │
│ note3.md    │─────►┌─────────────────────────────────────────────────┐
│ ...         │      │                                                 │
└─────────────┘      │   1. FILTER BY PATTERNS                         │
                     │      include: ["**/*.md"]                       │
                     │      exclude: ["**/node_modules/**"]            │
                     │                                                 │
                     └─────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                     ┌─────────────────────────────────────────────────┐
                     │   2. CHECK MODIFICATION TIME                    │
                     │      if file.mtime > db.mtime → needs update    │
                     └─────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                     ┌─────────────────────────────────────────────────┐
                     │   3. CHUNK CONTENT                              │
                     │      RecursiveCharacterTextSplitter             │
                     │      chunkSize: 1000, overlap: 200              │
                     │                                                 │
                     │      "# Title..."  →  [chunk1, chunk2, ...]     │
                     └─────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                     ┌─────────────────────────────────────────────────┐
                     │   4. GENERATE EMBEDDINGS                        │
                     │      For each chunk:                            │
                     │        embedding = provider.getEmbedding(chunk) │
                     │                                                 │
                     │      [0.123, -0.456, 0.789, ...]                │
                     └─────────────┬───────────────────────────────────┘
                                   │
                                   ▼
                     ┌─────────────────────────────────────────────────┐
                     │   5. STORE IN PGLITE                            │
                     │                                                 │
                     │   INSERT INTO embeddings                        │
                     │     (path, mtime, content, model,               │
                     │      dimension, embedding, metadata)            │
                     │   VALUES (...)                                  │
                     │                                                 │
                     └─────────────────────────────────────────────────┘
                                   │
                                   ▼
                     ┌─────────────────────────────────────────────────┐
                     │   .smtcmp_vector_db.tar.gz                      │
                     │                                                 │
                     │   ┌─────────────────────────────────────────┐   │
                     │   │ embeddings table                        │   │
                     │   │ ─────────────────────────────────────── │   │
                     │   │ id | path | content | embedding | ...   │   │
                     │   │ 1  | note1| chunk1  | [0.1,...]  |      │   │
                     │   │ 2  | note1| chunk2  | [0.2,...]  |      │   │
                     │   │ 3  | note2| chunk1  | [0.3,...]  |      │   │
                     │   └─────────────────────────────────────────┘   │
                     └─────────────────────────────────────────────────┘
```

### 2.3 Similarity Search Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  SIMILARITY SEARCH DATA FLOW                     │
└─────────────────────────────────────────────────────────────────┘

QUERY                               PROCESSING                    RESULTS
─────                               ──────────                    ───────

┌─────────────────┐
│ "How do I       │
│  implement      │
│  authentication │──────►┌─────────────────────────────────────────┐
│  in this app?"  │       │                                         │
└─────────────────┘       │   1. EMBED QUERY                        │
                          │      query_embedding =                  │
                          │        provider.getEmbedding(query)     │
                          │                                         │
                          │      → [0.234, -0.567, 0.890, ...]      │
                          │                                         │
                          └─────────────┬───────────────────────────┘
                                        │
                                        ▼
                          ┌─────────────────────────────────────────┐
                          │   2. VECTOR SIMILARITY SEARCH           │
                          │                                         │
                          │   SELECT content, path,                 │
                          │     1 - (embedding <=> query) as sim    │
                          │   FROM embeddings                       │
                          │   WHERE model = $model                  │
                          │     AND dimension = $dim                │
                          │   ORDER BY embedding <=> query          │
                          │   LIMIT 10                              │
                          │                                         │
                          └─────────────┬───────────────────────────┘
                                        │
                                        ▼
                          ┌─────────────────────────────────────────┐
                          │   3. FILTER BY SIMILARITY THRESHOLD     │
                          │      results.filter(r => r.sim >= 0.7)  │
                          │                                         │
                          └─────────────┬───────────────────────────┘
                                        │
                                        ▼
                          ┌─────────────────────────────────────────┐
                          │   SEARCH RESULTS                        │
                          │                                         │
                          │   [                                     │
                          │     {                                   │
                          │       path: "auth.md",                  │
                          │       content: "To implement auth...",  │
                          │       similarity: 0.92                  │
                          │     },                                  │
                          │     {                                   │
                          │       path: "login.md",                 │
                          │       content: "The login flow...",     │
                          │       similarity: 0.85                  │
                          │     },                                  │
                          │     ...                                 │
                          │   ]                                     │
                          └─────────────────────────────────────────┘
```

### 2.4 Settings Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     SETTINGS DATA FLOW                           │
└─────────────────────────────────────────────────────────────────┘

STORAGE                             RUNTIME                       UI
───────                             ───────                       ──

┌─────────────────┐
│ data.json       │
│ (vault/.obsidian│
│  /plugins/      │
│  smart-composer)│
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                        LOAD SETTINGS                             │
│                                                                 │
│   1. Read data.json                                             │
│   2. Parse JSON                                                 │
│   3. Check version                                              │
│          │                                                      │
│          ▼                                                      │
│   4. Run migrations (if needed)                                 │
│      0→1→2→3→...→12→13                                          │
│          │                                                      │
│          ▼                                                      │
│   5. Validate with Zod schema                                   │
│          │                                                      │
│          ▼                                                      │
│   6. Return SmartComposerSettings                               │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │      SettingsContext         │
              │                              │
              │  settings: SmartComposer-    │◄────────────────────┐
              │            Settings          │                     │
              │                              │                     │
              │  setSettings: (s) => void    │──┐                  │
              │                              │  │                  │
              └──────────────────────────────┘  │                  │
                             │                 │                  │
              ┌──────────────┴──────────────┐  │                  │
              │                             │  │                  │
              ▼                             ▼  │                  │
     ┌─────────────────┐          ┌─────────────────┐             │
     │    Chat View    │          │  Settings Tab   │             │
     │    (reads)      │          │  (reads/writes) │             │
     └─────────────────┘          └────────┬────────┘             │
                                           │                      │
                                           │  User changes        │
                                           │  a setting           │
                                           │                      │
                                           ▼                      │
                             ┌──────────────────────────────┐     │
                             │       SAVE SETTINGS          │     │
                             │                              │     │
                             │  1. setSettings(newSettings) │     │
                             │  2. Write to data.json       │     │
                             │  3. Notify listeners         │─────┘
                             │                              │
                             └──────────────────────────────┘
```

---

## 3. Sequence Diagrams

### 3.1 Chat Message Sequence

```
┌──────┐   ┌────────────┐   ┌───────────┐   ┌────────────┐   ┌──────────┐
│ User │   │ ChatInput  │   │   Chat    │   │  Provider  │   │   LLM    │
└──┬───┘   └─────┬──────┘   └─────┬─────┘   └─────┬──────┘   └────┬─────┘
   │             │                │               │               │
   │  Type msg   │                │               │               │
   │────────────►│                │               │               │
   │             │                │               │               │
   │  Enter      │                │               │               │
   │────────────►│                │               │               │
   │             │                │               │               │
   │             │  onSubmit()    │               │               │
   │             │───────────────►│               │               │
   │             │                │               │               │
   │             │                │  resolveMsg() │               │
   │             │                │──────────────►│               │
   │             │                │               │               │
   │             │                │  buildReq()   │               │
   │             │                │──────────────►│               │
   │             │                │               │               │
   │             │                │               │ streamResp()  │
   │             │                │               │──────────────►│
   │             │                │               │               │
   │             │                │               │◄─ chunk 1 ────│
   │             │                │◄──────────────│               │
   │◄────────────│                │               │               │
   │  Display    │                │               │               │
   │             │                │◄─ chunk 2 ────│               │
   │◄────────────│                │               │               │
   │  Display    │                │               │               │
   │             │                │◄─ chunk N ────│               │
   │◄────────────│                │               │               │
   │  Display    │                │               │               │
   │             │                │               │               │
   │             │                │  saveChat()   │               │
   │             │                │───────────────┼───────────────┘
   │             │                │               │
   └─────────────┴────────────────┴───────────────┘
```

### 3.2 RAG Query Sequence

```
┌──────┐   ┌───────────┐   ┌───────────┐   ┌────────────┐   ┌──────────┐
│ User │   │   Chat    │   │ RAGEngine │   │VectorMgr   │   │ PGlite   │
└──┬───┘   └─────┬─────┘   └─────┬─────┘   └─────┬──────┘   └────┬─────┘
   │             │               │               │               │
   │ Vault Chat  │               │               │               │
   │────────────►│               │               │               │
   │             │               │               │               │
   │             │ processQuery()│               │               │
   │             │──────────────►│               │               │
   │             │               │               │               │
   │             │               │ updateIndex() │               │
   │             │               │──────────────►│               │
   │             │               │               │               │
   │             │               │               │ getModified() │
   │             │               │               │──────────────►│
   │             │               │               │◄──────────────│
   │             │               │               │               │
   │             │               │               │ insertVecs()  │
   │             │               │               │──────────────►│
   │             │               │◄──────────────│               │
   │             │               │               │               │
   │             │               │ getEmbedding()│               │
   │             │               │───────────────┼───────────────┘
   │             │               │               │   (call LLM)
   │             │               │◄──────────────│
   │             │               │               │
   │             │               │ simSearch()   │
   │             │               │──────────────►│
   │             │               │               │
   │             │               │               │ SELECT ...    │
   │             │               │               │ ORDER BY <=>  │
   │             │               │               │──────────────►│
   │             │               │               │◄──────────────│
   │             │               │◄──────────────│               │
   │             │               │               │               │
   │             │◄──────────────│ results       │               │
   │             │               │               │               │
   │◄────────────│ display       │               │               │
   │             │               │               │               │
   └─────────────┴───────────────┴───────────────┴───────────────┘
```

### 3.3 MCP Tool Execution Sequence

```
┌──────┐   ┌───────────┐   ┌───────────┐   ┌────────────┐   ┌──────────┐
│ User │   │   Chat    │   │ McpManager│   │ MCP Client │   │MCP Server│
└──┬───┘   └─────┬─────┘   └─────┬─────┘   └─────┬──────┘   └────┬─────┘
   │             │               │               │               │
   │  Message    │               │               │               │
   │────────────►│               │               │               │
   │             │               │               │               │
   │             │  LLM returns  │               │               │
   │             │  tool_call    │               │               │
   │             │◄──────────────┼───────────────┼───────────────│
   │             │               │               │               │
   │  Approve?   │               │               │               │
   │◄────────────│               │               │               │
   │             │               │               │               │
   │  Yes        │               │               │               │
   │────────────►│               │               │               │
   │             │               │               │               │
   │             │   callTool()  │               │               │
   │             │──────────────►│               │               │
   │             │               │               │               │
   │             │               │  getClient()  │               │
   │             │               │──────────────►│               │
   │             │               │               │               │
   │             │               │               │ callTool()    │
   │             │               │               │──────────────►│
   │             │               │               │               │
   │             │               │               │  (execute)    │
   │             │               │               │               │
   │             │               │               │◄──────────────│
   │             │               │               │  result       │
   │             │               │◄──────────────│               │
   │             │◄──────────────│               │               │
   │             │               │               │               │
   │             │  Continue LLM │               │               │
   │             │  with result  │               │               │
   │             │───────────────┼───────────────┼───────────────┘
   │             │               │               │
   │◄────────────│  final resp   │               │
   │             │               │               │
   └─────────────┴───────────────┴───────────────┘
```

---

## 4. State Machines

### 4.1 Chat State Machine

```
┌─────────────────────────────────────────────────────────────────┐
│                    CHAT STATE MACHINE                            │
└─────────────────────────────────────────────────────────────────┘

                         ┌─────────────┐
                         │    IDLE     │
                         │             │
                         └──────┬──────┘
                                │
                                │ user sends message
                                ▼
                         ┌─────────────┐
                         │  THINKING   │◄────────────────────────┐
                         │  (loading)  │                         │
                         └──────┬──────┘                         │
                                │                                │
                    ┌───────────┼───────────┐                    │
                    │           │           │                    │
                    ▼           ▼           ▼                    │
           ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
           │  STREAMING  │ │  TOOL_CALL  │ │    ERROR    │       │
           │             │ │             │ │             │       │
           └──────┬──────┘ └──────┬──────┘ └──────┬──────┘       │
                  │               │               │              │
                  │               │ tool_result   │              │
                  │               └───────────────┼──────────────┘
                  │                               │
                  │ stream ends                   │ retry
                  │                               │
                  ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │  COMPLETE   │                 │    IDLE     │
           │             │                 │             │
           └──────┬──────┘                 └─────────────┘
                  │
                  │ user continues
                  ▼
           ┌─────────────┐
           │    IDLE     │
           └─────────────┘
```

### 4.2 MCP Server State Machine

```
┌─────────────────────────────────────────────────────────────────┐
│                  MCP SERVER STATE MACHINE                        │
└─────────────────────────────────────────────────────────────────┘

              ┌────────────────┐
              │  DISCONNECTED  │◄────────────────────────────────┐
              │                │                                 │
              └───────┬────────┘                                 │
                      │                                          │
                      │ connect()                                │
                      ▼                                          │
              ┌────────────────┐                                 │
              │  CONNECTING    │                                 │
              │                │                                 │
              └───────┬────────┘                                 │
                      │                                          │
          ┌───────────┼───────────┐                              │
          │           │           │                              │
          ▼           │           ▼                              │
  ┌────────────────┐  │   ┌────────────────┐                     │
  │   CONNECTED    │  │   │     ERROR      │                     │
  │                │  │   │                │                     │
  └───────┬────────┘  │   └───────┬────────┘                     │
          │           │           │                              │
          │           │           │ retry / manual               │
          │           │           ▼                              │
          │           │   ┌────────────────┐                     │
          │           └──►│  CONNECTING    │                     │
          │               │                │                     │
          │               └────────────────┘                     │
          │                                                      │
          │ disconnect()                                         │
          └──────────────────────────────────────────────────────┘
```

### 4.3 Indexing State Machine

```
┌─────────────────────────────────────────────────────────────────┐
│                  INDEXING STATE MACHINE                          │
└─────────────────────────────────────────────────────────────────┘

                     ┌─────────────┐
                     │   READY     │
                     │             │
                     └──────┬──────┘
                            │
                            │ start indexing
                            ▼
                     ┌─────────────┐
                     │  SCANNING   │
                     │   files     │
                     └──────┬──────┘
                            │
                            │ files found
                            ▼
                     ┌─────────────┐
            ┌───────►│  CHUNKING   │
            │        │   content   │
            │        └──────┬──────┘
            │               │
            │               │ chunks ready
            │               ▼
            │        ┌─────────────┐
            │        │  EMBEDDING  │◄────────────────┐
            │        │   chunks    │                 │
            │        └──────┬──────┘                 │
            │               │                        │
            │     ┌─────────┼─────────┐              │
            │     │         │         │              │
            │     ▼         │         ▼              │
            │ ┌────────┐    │    ┌────────┐          │
            │ │  DONE  │    │    │RATE_LIM│──────────┘
            │ │  file  │    │    │ WAIT   │  (retry after delay)
            │ └────┬───┘    │    └────────┘
            │      │        │
            │      │        │ more files?
            └──────┼────────┘
                   │
                   │ all done
                   ▼
             ┌─────────────┐
             │  COMPLETE   │
             │             │
             └──────┬──────┘
                    │
                    │ save db
                    ▼
             ┌─────────────┐
             │   READY     │
             └─────────────┘
```

---

## 5. Error Flows

### 5.1 API Error Handling

```
┌─────────────────────────────────────────────────────────────────┐
│                    API ERROR HANDLING                            │
└─────────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │   API Request   │
            └────────┬────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
   ┌───────────┐           ┌───────────┐
   │  SUCCESS  │           │   ERROR   │
   │           │           │           │
   └─────┬─────┘           └─────┬─────┘
         │                       │
         │               ┌───────┴───────────────────────────────┐
         │               │                                       │
         │               ▼                                       ▼
         │       ┌───────────────┐                       ┌───────────────┐
         │       │   401/403     │                       │   429/500+    │
         │       │  Auth Error   │                       │  Rate/Server  │
         │       └───────┬───────┘                       └───────┬───────┘
         │               │                                       │
         │               ▼                                       ▼
         │       ┌───────────────┐                       ┌───────────────┐
         │       │ Show "API key │                       │   Retry with  │
         │       │ invalid" with │                       │   exponential │
         │       │ settings link │                       │   backoff     │
         │       └───────────────┘                       └───────┬───────┘
         │                                                       │
         │                                       ┌───────────────┴───────────────┐
         │                                       │                               │
         │                                       ▼                               ▼
         │                               ┌───────────────┐               ┌───────────────┐
         │                               │   SUCCESS     │               │   MAX RETRIES │
         │                               │   (retry ok)  │               │   EXCEEDED    │
         │                               └───────────────┘               └───────┬───────┘
         │                                                                       │
         │                                                                       ▼
         │                                                               ┌───────────────┐
         └───────────────────────────────────────────────────────────────┤   Show error  │
                                                                         │   message     │
                                                                         └───────────────┘
```

### 5.2 Database Error Handling

```
┌─────────────────────────────────────────────────────────────────┐
│                  DATABASE ERROR HANDLING                         │
└─────────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │   DB Operation  │
            └────────┬────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
   ┌───────────┐           ┌───────────┐
   │  SUCCESS  │           │   ERROR   │
   │           │           │           │
   └───────────┘           └─────┬─────┘
                                 │
                     ┌───────────┴───────────┐
                     │                       │
                     ▼                       ▼
             ┌───────────────┐       ┌───────────────┐
             │   CORRUPTED   │       │   LOAD FAIL   │
             │   DATABASE    │       │  (WASM error) │
             └───────┬───────┘       └───────┬───────┘
                     │                       │
                     ▼                       ▼
             ┌───────────────┐       ┌───────────────┐
             │ Delete and    │       │ Retry CDN     │
             │ recreate DB   │       │ fetch         │
             └───────┬───────┘       └───────┬───────┘
                     │                       │
                     ▼                       ▼
             ┌───────────────┐       ┌───────────────┐
             │ Warn user:    │       │ If still fail:│
             │ "Index reset, │       │ show offline  │
             │ rebuilding"   │       │ error message │
             └───────────────┘       └───────────────┘
```

---

**END OF FLOW DIAGRAMS**
